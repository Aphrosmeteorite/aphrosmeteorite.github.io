<!doctype html><html lang=zh-CN data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.113.0"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16_next.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32_32_next.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="一个设计让你的C++只需要一个赋值运算符！"><meta itemprop=description content="A design to so that your C++ needs only one assignment operator"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://laplace825.github.io/imgs/kana.png"><meta itemprop=keywords content="C++"><meta property="og:type" content="article"><meta property="og:title" content="一个设计让你的C++只需要一个赋值运算符！"><meta property="og:description" content="A design to so that your C++ needs only one assignment operator"><meta property="og:image" content="/imgs/kana.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://laplace825.github.io/post/exception-cpp/"><meta property="og:site_name" content="lap的小站"><meta property="og:locale" content="zh-CN"><meta property="article:author" content="Laplace"><meta property="article:published_time" content="2024-02-20 00:00:00 +0000 UTC"><meta property="article:modified_time" content="2024-02-20 00:00:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.95e3e4467539ccbfc95e4c2e91f11c57be7967f38f879e7a6ae8112bc850b29f.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"math":{"js":{"file":"es5/tex-mml-chtml.js","name":"mathjax","version":"3.2.0"},"render":"mathjax"},"path":"exception-cpp","permalink":"https://laplace825.github.io/post/exception-cpp/","title":"一个设计让你的C++只需要一个赋值运算符！","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"3HTyuds4Bm5FaDq4",ck:"3HTyuds4Bm5FaDq4",autoTrack:!0})},document.head.appendChild(e)})</script><title>一个设计让你的C++只需要一个赋值运算符！ - lap的小站</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>lap的小站</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>When the SUN Rises in the EAST</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>首页</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>关于</a></li><li class="menu-item menu-item-flinks"><a href=/flinks.html class=hvr-icon-pulse rel=section><i class="fa fa-thumbs-up hvr-icon"></i>友情链接</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>归档
<span class=badge>18</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目录</li><li class=sidebar-nav-overview>站点概览</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#说明>说明</a></li><li><a href=#构造函数和拷贝构造函数的设计>构造函数和拷贝构造函数的设计</a></li><li><a href=#析构函数>析构函数</a></li><li><a href=#swap函数和copy函数>swap函数和copy函数</a></li><li><a href=#进入正题>进入正题！</a><ul><li><a href=#移动构造函数>移动构造函数</a></li><li><a href=#赋值运算符>赋值运算符</a><ul><li><a href=#传入左值的情况>传入左值的情况</a></li><li><a href=#传入右值的情况>传入右值的情况</a></li></ul></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Laplace src=/imgs/img-lazy-loading.gif data-src=/imgs/kana.png><p class=site-author-name itemprop=name>Laplace</p><div class=site-description itemprop=description>当太阳从东方升起</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>18</span>
<span class=site-state-item-name>日志</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>分类</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>5</span>
<span class=site-state-item-name>标签</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/Laplace825 title="Github → https://github.com/Laplace825" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github</a></span>
<span class=links-of-social-item><a href=laplace_yongle_he@163.com title="E-Mail → laplace_yongle_he@163.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i>
E-Mail</a></span></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa fa-globe fa-fw"></i>
友情链接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href title target=_blank>暂无 QAQ</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>网站资讯</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已运行：</div><div class=item-count id=runTimes data-publishdate=0001-01-01T00:00:00+00:00></div></div><div id=la-siteinfo-widget style=display:none></div><div class=siteinfo-item><div class=item-name><i class="fa fa-user-plus"></i>今日访问：</div><div class=item-count id=today_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-user-clock"></i>昨日访问：</div><div class=item-count id=yesterday_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-arrows-down-to-people"></i>本月访问：</div><div class=item-count id=month_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-users"></i>总访问量：</div><div class=item-count id=total_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>总字数：</div><div class=item-count id=wordsCount data-count=17761></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>阅读约：</div><div class=item-count id=readTimes data-times=45></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最后更新于：</div><div class=item-count id=last-push-date data-lastpushdate=2024-04-06T00:00:00+00:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-gtranslate class=button title=多语言翻译><i class="fas fa-globe"></i></div><div id=toggle-theme class=button title=深浅模式切换><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回顶部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a>
<a href=https://github.com/laplace825 rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub ฅ( ̳• ◡ • ̳)ฅ" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://laplace825.github.io/post/exception-cpp/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/kana.png"><meta itemprop=name content="Laplace"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Laplace"><meta itemprop=description content="当太阳从东方升起"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="一个设计让你的C++只需要一个赋值运算符！"><meta itemprop=description content="A design to so that your C++ needs only one assignment operator"></span><header class=post-header><h1 class=post-title itemprop="name headline">一个设计让你的C++只需要一个赋值运算符！</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title=发表于>发表于：</span>
<time title="创建时间：2024-02-20 00:00:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2024-02-20 00:00:00 +0000 UTC">2024-02-20</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title=分类于>分类于：</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/c++ itemprop=url rel=index><span itemprop=name>C++</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字数><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>字数：</span>
<span>1727</span></span>
<span class=post-meta-item title=阅读><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>阅读：&ap;</span>
<span>4分钟</span></span></div></div></header><div class="post-body autonumber" itemprop=articleBody><p><del>希望没有标题党的意思</del>,一个有趣且巧妙的设计,可以让一些类只需要两个构造函数,而我们只需要额外增加的只有<code>swap</code>和<code>copy</code></p><h2 id=说明>说明
<a class=header-anchor href=#%e8%af%b4%e6%98%8e></a></h2><ul><li>以下将以类<code>Buffer</code>作为例子</li><li>需要具有一定的左值和右值相关前置知识</li><li>同时涉及到异常处理相关内容</li></ul><p><code>Buffer</code>类的设计如下</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Buffer</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span><span style=color:#ff79c6>private</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>m_data; <span style=color:#6272a4>// 存放字符串
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    std<span style=color:#ff79c6>::</span>size_t m_length; <span style=color:#6272a4>// 字符串长度
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    std<span style=color:#ff79c6>::</span>size_t m_capacity; <span style=color:#6272a4>// 字符串的容量
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>public</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>explicit</span> Buffer(std<span style=color:#ff79c6>::</span>size_t length); <span style=color:#6272a4>// 构造函数
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#ff79c6>~</span>Buffer(); <span style=color:#6272a4>// 析构函数
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    Buffer(<span style=color:#ff79c6>const</span> Buffer <span style=color:#ff79c6>&amp;</span>rhs); <span style=color:#6272a4>// 拷贝构造
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    Buffer(Buffer <span style=color:#ff79c6>&amp;&amp;</span>rhs) <span style=color:#ff79c6>noexcept</span>; <span style=color:#6272a4>// 移动构造
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    Buffer <span style=color:#ff79c6>&amp;</span><span style=color:#ff79c6>operator</span><span style=color:#ff79c6>=</span>(Buffer rhs) <span style=color:#ff79c6>noexcept</span>; <span style=color:#6272a4>// 赋值运算符
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>swap</span>(Buffer <span style=color:#ff79c6>&amp;</span>rhs) <span style=color:#ff79c6>noexcept</span>; <span style=color:#6272a4>// 类内swap函数
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>};
</span></span></code></pre></div><h2 id=构造函数和拷贝构造函数的设计>构造函数和拷贝构造函数的设计
<a class=header-anchor href=#%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0%e5%92%8c%e6%8b%b7%e8%b4%9d%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0%e7%9a%84%e8%ae%be%e8%ae%a1></a></h2><p>这里两个函数的设计很常规,以下直接给出代码做参考（函数定义写在类内）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>explicit</span> <span style=color:#50fa7b>Buffer</span>(std<span style=color:#ff79c6>::</span>size_t length)
</span></span><span style=display:flex><span><span style=color:#ff79c6>try</span> <span style=color:#ff79c6>:</span> m_data(length <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>char</span>[length] <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>nullptr</span>), m_length(<span style=color:#bd93f9>0</span>), m_capacity(length)
</span></span><span style=display:flex><span>{ 
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>catch</span> (<span style=color:#ff79c6>const</span> std<span style=color:#ff79c6>::</span>bad_alloc <span style=color:#ff79c6>&amp;</span>e)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>cerr <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Failed to allocate memory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>cerr <span style=color:#ff79c6>&lt;&lt;</span> e.what() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>delete</span>[] m_data;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>throw</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Buffer(<span style=color:#ff79c6>const</span> Buffer <span style=color:#ff79c6>&amp;</span>rhs)
</span></span><span style=display:flex><span><span style=color:#ff79c6>try</span> <span style=color:#ff79c6>:</span> m_length(rhs.m_length),m_capacity(rhs.m_capacity),m_data(rhs.m_capacity <span style=color:#ff79c6>&gt;</span> <span style=color:#bd93f9>0</span> <span style=color:#ff79c6>?</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd>char</span>[rhs.m_capacity] <span style=color:#ff79c6>:</span> <span style=color:#ff79c6>nullptr</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>copy(rhs.m_data, rhs.m_data <span style=color:#ff79c6>+</span> rhs.m_length, m_data);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>catch</span> (<span style=color:#ff79c6>const</span> std<span style=color:#ff79c6>::</span>bad_alloc <span style=color:#ff79c6>&amp;</span>e)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>cerr <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;Failed to allocate memory</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>cerr <span style=color:#ff79c6>&lt;&lt;</span> e.what() <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#39;\n&#39;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>delete</span>[] m_data;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>throw</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里可能显示起来比较丑，可以在编辑器中自动格式化代码会好看一些。两个构造函数其实整体差别不大，利用初始化列表进行类内各值的初始化，同时也保证能够捕捉到异常，这里需要判断<code>m_data</code>是否应该为空指针。同时由于当构造函数出现异常时，<strong>对象不会被构造</strong>，所以析构函数无法自己调用，这时候我们需要在<code>catch</code>语句中写<code>delete</code>。</p><h2 id=析构函数>析构函数
<a class=header-anchor href=#%e6%9e%90%e6%9e%84%e5%87%bd%e6%95%b0></a></h2><p>这个应该没什么好说的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>~</span>Buffer()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>cout <span style=color:#ff79c6>&lt;&lt;</span> <span style=color:#f1fa8c>&#34;~Buffer</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>delete</span>[] m_data;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=swap函数和copy函数>swap函数和copy函数
<a class=header-anchor href=#swap%e5%87%bd%e6%95%b0%e5%92%8ccopy%e5%87%bd%e6%95%b0></a></h2><p>由于移动构造和赋值运算符都需要这两个函数，所以先写了。<code>copy</code>其实是调用的<code>std::copy()</code>，而<code>swap</code>则是把所有的交换都封装起来，内部也是调用<code>std::swap()</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>swap</span>(Buffer <span style=color:#ff79c6>&amp;</span>rhs) <span style=color:#ff79c6>noexcept</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>swap(m_data, rhs.m_data);
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>swap(m_length, rhs.m_length);
</span></span><span style=display:flex><span>    std<span style=color:#ff79c6>::</span>swap(m_capacity, rhs.m_capacity);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>为保证效率，在交换时选择直接交换指针而不是用中间变量去拷贝。</p><h2 id=进入正题>进入正题！
<a class=header-anchor href=#%e8%bf%9b%e5%85%a5%e6%ad%a3%e9%a2%98></a></h2><h3 id=移动构造函数>移动构造函数
<a class=header-anchor href=#%e7%a7%bb%e5%8a%a8%e6%9e%84%e9%80%a0%e5%87%bd%e6%95%b0></a></h3><p>这里先给出代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>Buffer(Buffer <span style=color:#ff79c6>&amp;&amp;</span>rhs) <span style=color:#ff79c6>noexcept</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>:</span> Buffer(<span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span><span style=color:#6272a4>// 这里将*this构造为一个容量为0的Buffer,然后与rhs交换
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>{
</span></span><span style=display:flex><span>    swap(rhs);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在<code>C++</code>当中，被传入的<code>rhs</code>视为将亡值，构造执行完毕，则传入的<code>rhs</code>已不再能直接正常使用。这里在初始化参数列表直接调用构造函数将<code>this</code>构造为”空对象“——空指针且容量长度都为0。然后将该对象与<code>rhs</code>交换完成移动构造。</p><h3 id=赋值运算符>赋值运算符
<a class=header-anchor href=#%e8%b5%8b%e5%80%bc%e8%bf%90%e7%ae%97%e7%ac%a6></a></h3><p>还是先给出代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>Buffer <span style=color:#ff79c6>&amp;</span><span style=color:#ff79c6>operator</span><span style=color:#ff79c6>=</span>(Buffer rhs) <span style=color:#ff79c6>noexcept</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 传值调用,这里rhs会调用拷贝构造函数
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    <span style=color:#6272a4>// 临时变量被swap,然后析构
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    swap(rhs);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=传入左值的情况>传入左值的情况
<a class=header-anchor href=#%e4%bc%a0%e5%85%a5%e5%b7%a6%e5%80%bc%e7%9a%84%e6%83%85%e5%86%b5></a></h4><p>传入左值时，我们知道在<code>C++</code>中需要拷贝临时变量，将传入值拷贝给<code>rhs</code>，然后在内部与<code>*this</code>做交换，可以发现，这里只有一次拷贝构造，并且拷贝构造函数是一个强异常安全函数，也同时保证了在左值赋值时仍然是强安全类型。由于<code>rhs</code>是拷贝的临时变量，所以交换不会影响原来的传入值。</p><p>还有一个优点，传统写法我们会将<code>this->m_data</code>先进行<code>delete</code>，然后将<code>rhs.m_data</code>进行过拷贝，也就是深拷贝，但是我们忽略了一件事，这里出现了两次拷贝，一次在构造<code>rhs</code>这个临时变量，一次在构造<code>this->m_data</code>，而这个写法减少了一次拷贝。当然，如果认识到了<code>rhs</code>是临时变量，那么我们直接把<code>rhs.m_data</code>与<code>this->m_data</code>的指针交换，也可以省去一次拷贝，但是写法却远不及<code>swap</code>来的简单。</p><h4 id=传入右值的情况>传入右值的情况
<a class=header-anchor href=#%e4%bc%a0%e5%85%a5%e5%8f%b3%e5%80%bc%e7%9a%84%e6%83%85%e5%86%b5></a></h4><p>传入右值时同样要进行构造，不过这里是调用移动构造函数，<code>rhs</code>的构造需要调用移动构造函数，此时会初始化一个<code>Buffer(0)</code>这样的空对象（这个对象就是<code>rhs</code>）并与传入的右值（也许说将亡值会更好？）进行交换。</p><p><code>explicit Buffer(std::size_t length)</code>函数是一个强异常安全函数，一同保证了移动构造函数的安全。得到<code>rhs</code>后，传入的右值（也许说将亡值好？）变为空对象，然后继续走<code>operator=</code>的函数体。此时直接将<code>rhs</code>与当前对象做交换即可，交换后<code>rhs</code>离开作用域就自动析构。</p><p>在传统写法中，我们会多写一个这样的函数<code>Buffer &amp;operator=(Buffer &&amp;rhs) noexcept</code>，这个函数也能完成移动构造，内部也是执行指针的交换。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>this</span> <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>&amp;</span>rhs)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>delete</span>[] m_data;
</span></span><span style=display:flex><span>    m_data <span style=color:#ff79c6>=</span> rhs.m_data;
</span></span><span style=display:flex><span>    m_length <span style=color:#ff79c6>=</span> rhs.m_length;
</span></span><span style=display:flex><span>    m_capacity <span style=color:#ff79c6>=</span> rhs.m_capacity;
</span></span><span style=display:flex><span>    rhs.m_data <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>nullptr</span>;
</span></span><span style=display:flex><span>    rhs.m_length <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    rhs.m_capacity <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>return</span> <span style=color:#ff79c6>*</span><span style=color:#ff79c6>this</span>;
</span></span></code></pre></div><p>在这个函数中，<code>delete</code>会抛出异常，当<code>delete</code>抛出异常时，后续操作不再执行，并没有继续更改其他值，但是如果我们把顺序交换一下（如下），当<code>delete</code>抛出异常时，<code>m_length</code>和<code>m_capacity</code>的已经被修改了，此时即使捕获异常，也无法拿回原来的数据了，而且这两个值的错误修改对<code>Buffer</code>对象而言是致命的。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-cpp data-lang=cpp><span style=display:flex><span>m_length <span style=color:#ff79c6>=</span> rhs.m_length;
</span></span><span style=display:flex><span>m_capacity <span style=color:#ff79c6>=</span> rhs.m_capacity;
</span></span><span style=display:flex><span><span style=color:#ff79c6>delete</span>[] m_data;
</span></span><span style=display:flex><span>m_data <span style=color:#ff79c6>=</span> rhs.m_data;
</span></span></code></pre></div></div><footer class=post-footer><div class=post-tags><a href=/tags/c++>C++</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知识><ul><li class=post-copyright-title><strong>文章标题：</strong>
一个设计让你的C++只需要一个赋值运算符！</li><li class=post-copyright-author><strong>原文作者：</strong>
Laplace</li><li class=post-copyright-link><strong>本文链接：</strong>
<a id=post-cr-link href=https://laplace825.github.io/post/exception-cpp/ title=一个设计让你的C++只需要一个赋值运算符！>https://laplace825.github.io/post/exception-cpp/</a></li><li class=post-copyright-license><strong>版权声明：</strong>
本博客所有文章除特别声明外，均采用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><div class=followme><span>欢迎关注我的其它发布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://github.com//laplace825><span class=icon><i class="fab fa-github"></i></span>
<span class=label>Github</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/some-pitfalls-encountered-1/ rel=next title=最近遇到的一些坑(C++)><i class="fa fa-chevron-left"></i> 最近遇到的一些坑(C++)</a></div><div class="post-nav-prev post-nav-item"><a href=/post/find-mycomputer/ rel=prev title=关于我的计算机中的发现——小端存储>关于我的计算机中的发现——小端存储
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div id=gtranslate class=google-translate><i class="fa fa-language"></i><div id=google_translate_element></div></div><div class=copyright>&copy;
<span itemprop=copyrightYear>2023 - 2024</span>
<span class=with-love><i class="fa fa-heart"></i></span>
<span class=author itemprop=copyrightHolder>Laplace</span></div><div class=powered-by>由 <a href=https://gohugo.io title=0.113.0 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.3 target=_blank>Hugo NexT.Gemini</a> 强力驱动</div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#22ffff","enable":true,"save":"auto"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://laplace825.github.io","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小时前","ds_hours":" 小时 ","ds_just":"刚刚","ds_min":" 分钟前","ds_mins":" 分钟","ds_month":" 个月前","ds_years":" 年 ","empty":"没有找到任何搜索结果：${query}","hits":"找到 ${hits} 个搜索结果","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-CN","lawidget":{"id":"3HTyuds4Bm5FaDq4","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"zoomInLeft","postblock":"zoomInLeft","postbody":"zoomIn","postheader":"bounceIn","sidebar":"zoomInLeft"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":false,"plugin":"waline"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.c049c1b7d9c723cbb3235c27536312cf1b62688f1c5b544ef5102e4713f28536.js defer></script>
<script type=text/javascript src=/js/math.min.a6ada19a368d85dad9ead2040d86ae561a867fafef89391d1aa2aa5909366509.js defer></script></body></html>